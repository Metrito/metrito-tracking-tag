!async function(){function e(e){let t=new Uint32Array(4);crypto.getRandomValues(t);let a=Array.from(t,e=>e.toString(36)).join("");return`${e}_${a}`}class t{static error(...e){console.error("[ERROR] Tracking:",...e)}static info(...e){console.log("[INFO] Tracking:",...e)}}class a{static setItem(e,t){localStorage.setItem(e,t)}static getItem(e){return localStorage.getItem(e)}static setJsonItem(e,t){localStorage.setItem(e,JSON.stringify(t))}static getJsonItem(e){let t=localStorage.getItem(e);return t?JSON.parse(t):null}}class o{constructor(e){this.leadId=e,this.utmParams=this.extractUTMs()}extractUTMs(){let e=new URLSearchParams(window.location.search),a={};return["utm_source","utm_medium","utm_campaign","utm_content","utm_term",].forEach(t=>{e.has(t)&&(a[t]=e.get(t))}),t.info("Extracted UTM parameters:",a),a}addUTMsAndLeadIdToUrl(e){let t=new URLSearchParams(window.location.search);for(let[a,o]of(t.has("lead_id")||t.set("lead_id",this.leadId),Object.entries(this.utmParams)))t.has(a)||t.set(a,o);let i=`${e.split("?")[0]}?${t.toString()}`;return i}updateUrl(){let e=this.addUTMsAndLeadIdToUrl(window.location.href);window.history.replaceState({path:e},"",e),t.info("Updated URL with UTM parameters and lead_id:",e)}}let i=new class i{constructor(){this.backendUrl="http://localhost:4000/v2/tracking",this.ipInfoToken="BB9F053F0108613A9CCD7D8DF0B21A47"}async init(){this.leadId=await this.getOrCreateLeadId(),this.utmHandler=new o(this.leadId),this.utmHandler.updateUrl(),this.trackPageView()}async createLead(e){let o=await this.getGeolocation(),{fbc:i,fbp:n}=this.getFacebookCookies(),r={domain:window.location.hostname,createdInUrl:window.location.href,leadId:e,geolocation:{...o,state:o.region},metaAds:{cookies:{fbc:i,fbp:n}}};try{let s=await fetch(`${this.backendUrl}/leads`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!s.ok)throw Error(`Failed to create lead: ${s.statusText}`);t.info("Lead successfully created",r),a.setJsonItem("geolocation",o)}catch(c){t.error("Error creating lead:",c)}}async getOrCreateLeadId(){let o=a.getItem("lead_id");return o?t.info("Existing lead ID retrieved:",o):(o=e("lead"),a.setItem("lead_id",o),t.info("New lead ID generated:",o),await this.createLead(o)),o}getFacebookCookies(){let e=document.cookie.split("; ").reduce((e,t)=>{let[a,o]=t.split("=");return e[a]=o,e},{});return{fbc:e._fbc||null,fbp:e._fbp||null}}async getGeolocation(){let e=a.getJsonItem("geolocation");if(e)t.info("Geolocation retrieved from localStorage:",e);else try{let o=await fetch(`https://ipinfo.io/json?key=${this.ipInfoToken}`);e=await o.json(),t.info("Geolocation retrieved:",e)}catch(i){return t.error("Error retrieving geolocation:",i),{}}return e}async trackEvent(a,o){let i=navigator.userAgent,{fbc:n,fbp:r}=this.getFacebookCookies(),s=await this.getGeolocation(),c={leadId:this.leadId,eventType:a,eventData:o,eventId:e("event"),eventName:"page_view",eventTime:new Date().getTime(),timestamp:new Date().toISOString(),page:window.location.href,connectionId:"66becae58c04dec0c5024e2b",metadata:{userAgent:i,geolocation:{...s,state:s.region},...this.utmHandler.utmParams},metaAds:{cookies:{fbc:n,fbp:r}}};t.info(`Tracking event: ${a}`,c),await this.sendEventToBackend(c)}async sendEventToBackend(e){try{let a=await fetch(`${this.backendUrl}/events`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!a.ok)throw Error(`Failed to send event data: ${a.statusText}`);t.info("Event data successfully sent to backend",e)}catch(o){t.error("Error sending event data to backend:",o)}}trackPageView(){this.trackEvent("page_view",{url:window.location.href})}};await i.init()}();