// v0.0.1
!async function(){function t(t){const e=new Uint32Array(4);crypto.getRandomValues(e);return`${t}_${Array.from(e,(t=>t.toString(36))).join("")}`}function e(){const t=document.querySelector("link[rel~='icon']");return t?t.href:(console.warn("Favicon not found."),null)}console.log("Tracking initialized with container:",window.location.host);class n{static error(...t){console.error("[ERROR] Tracking:",...t)}static info(...t){console.log("[INFO] Tracking:",...t)}}class a{static setItem(t,e){localStorage.setItem(t,e)}static getItem(t){return localStorage.getItem(t)}static setJsonItem(t,e){localStorage.setItem(t,JSON.stringify(e))}static getJsonItem(t){const e=localStorage.getItem(t);return e?JSON.parse(e):null}}class o{constructor(t){this.leadId=t,this.utmParams=this.extractUTMs()}extractUTMs(){const t=new URLSearchParams(window.location.search),e={};return t.forEach(((t,n)=>{"src"!==n||t.includes("lead_")?e[n]=t:e[n]=`${t}__${this.leadId}`})),n.info("Extracted and modified URL parameters:",e),e}addUTMsAndLeadIdToUrl(t){const e=new URLSearchParams(window.location.search);e.has("lead_id")||e.set("lead_id",this.leadId);for(const[t,n]of Object.entries(this.utmParams))e.set(t,n);return`${t.split("?")[0]}?${e.toString()}`}updateUrl(){const t=this.addUTMsAndLeadIdToUrl(window.location.href);window.history.replaceState({path:t},"",t),n.info("Updated URL with UTM parameters and lead_id:",t)}}const i=new class{constructor(){this.containerDomain=window.location.host,this.backendUrl="https://tracking.metrito.com",this.ipInfoToken="BB9F053F0108613A9CCD7D8DF0B21A47"}async init(){this.leadId=await this.getOrCreateLeadId(),this.utmHandler=new o(this.leadId),this.utmHandler.updateUrl(),this.trackPageView()}async createLead(t){const e=navigator.userAgent,i=await this.getGeolocation(),{fbc:r,fbp:s}=this.getFacebookCookies(),c=this.getPageContent();this.utmHandler=new o(t);const d={domain:window.location.hostname,createdInUrl:window.location.href,leadId:t,containerDomain:this.containerDomain,metadata:{userAgent:e,...this.utmHandler.utmParams},pageContent:c,metaAds:{cookies:{fbc:r,fbp:s}},geolocation:{...i,state:i.region}};try{const t=await fetch(`${this.backendUrl}/leads`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!t.ok)throw new Error(`Failed to create lead: ${t.statusText}`);n.info("Lead successfully created",d),a.setJsonItem("geolocation",i)}catch(t){n.error("Error creating lead:",t)}}async getOrCreateLeadId(){let e=a.getItem("lead_id");return e?n.info("Existing lead ID retrieved:",e):(e=t("lead"),a.setItem("lead_id",e),n.info("New lead ID generated:",e),await this.createLead(e)),e}getFacebookCookies(){const t=document.cookie.split("; ").reduce(((t,e)=>{const[n,a]=e.split("=");return t[n]=a,t}),{});return{fbc:t._fbc||null,fbp:t._fbp||null}}async getGeolocation(){let t=a.getJsonItem("geolocation");if(t)n.info("Geolocation retrieved from localStorage:",t);else try{const e=await fetch(`https://ipinfo.io/json?key=${this.ipInfoToken}`);t=await e.json(),n.info("Geolocation retrieved:",t)}catch(t){return n.error("Error retrieving geolocation:",t),{}}return t}async trackEvent(e,a){const o=navigator.userAgent,{fbc:i,fbp:r}=this.getFacebookCookies(),s=await this.getGeolocation(),c=this.getPageContent(),d={containerDomain:this.containerDomain,leadId:this.leadId,eventId:t("event"),eventType:e,eventName:e,eventTime:(new Date).getTime(),timestamp:(new Date).toISOString(),eventData:a,page:window.location.href,metadata:{userAgent:o,...this.utmHandler.utmParams},pageContent:c,metaAds:{cookies:{fbc:i,fbp:r}},geolocation:{...s,state:s.region}};n.info(`Tracking event: ${e}`,d),await this.sendEventToBackend(d)}async sendEventToBackend(t){try{const e=await fetch(`${this.backendUrl}/events`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(`Failed to send event data: ${e.statusText}`);n.info("Event data successfully sent to backend",t)}catch(t){n.error("Error sending event data to backend:",t)}}trackPageView(){this.trackEvent("PageView",{url:window.location.href})}getPageContent(){const t=document.querySelectorAll("meta[name='description']"),n=t.length>0?t[0].getAttribute("content"):"";return{title:document.title,description:n,url:window.location.href,referrer:document.referrer,language:navigator.language,favicon:e()}}}(this.containerDomain);await i.init()}();